---
title: MATLAB中的二维矩阵反卷积
tags: 
- Algorithm
- Code
- MATLAB
cover: 
---
MATLAB提供了向量的反卷积函数[`deconv()`](https://www.mathworks.com/help/matlab/ref/deconv.html)，但是没有直接提供将二维矩阵进行反卷积操作的函数。通过对二维卷积函数[`conv2()`](https://www.mathworks.com/help/matlab/ref/conv2.html)的分析，可以写出对二维矩阵进行反卷积操作的函数`deconv2()`。
<!--more-->

在MATLAB中，二维卷积函数`C = conv2(A,B)`的输出被定义为

$$C(i,j)=\sum_p\sum_qA(p,q)B(i-p+1,j-q+1)\tag{1}$$

其中 $p$ 和 $q$ 遍历所有合法取值。显然，

$$\forall\ i>1,\ C(i,:)\neq\mathrm{conv}(A(i,:),B(i,:))\tag{2}$$

因此不能直接使用`deconv()`函数求反卷积。但是当 $i=1$ 时上式却是成立的，因此可以使用`deconv()`函数通过 $C(1,:)$ 和 $B(1,:)$ 求出 $A(1,:)$。

分析式(1)，不难发现：

$$\forall\ i\in\{1,2,\dots,r_a\},\ C(i,:)=\mathrm{conv}(A(i,:),B(1,:))+H(i,:)\tag{3}\label{base}$$

其中 $r_a$ 是矩阵 $A$ 的行数，$H$ 定义为`H=conv2(A(1:i-1,:),B)`。这为迭代求解反卷积提供了可能。式(3)证明如下：

---
矩阵 $A$ 大小为 $r_a\times c_a$，矩阵 $B$ 大小为 $r_b\times c_b$。令

$$c=\mathrm{conv}(A(i,:),B(1,:))\tag{4}$$

则 $c$ 的大小为 $1\times(c_a+c_b-1)$，第 $j$ 个元素为：

$$c(j)=\sum_{q=\max(1,j-c_b+1)}^{\min(j,c_a)}A(i,q)B(1,j-q+1)\tag{5}$$

令

$$H=\mathrm{conv2}(A(1:i-1,:),B)\tag{6}$$

则 $H$ 的大小为 $(i+r_b-2)\times(c_a+c_b-1)$，元素 $H(i,j)$ 为：

$$H(i,j)=\sum_{p=\max(1,i-r_b+1)}^{i-1}\sum_{q=\max(1,j-c_b+1)}^{\min(j,c_a)}A(p,q)B(i-p+1,j-q+1)\tag{7}$$

则：

$$c(j)+H(i,j)=\sum_{p=\max(1,i-r_b+1)}^{\color{red}{i}}\sum_{q=\max(1,j-c_b+1)}^{\min(j,c_a)}A(p,q)B(i-p+1,j-q+1)=C(i,j)\tag{8}$$

---

故可以通过迭代的方法进行反卷积操作：
- 先通过 $C(1,:)$ 和 $B(1,:)$ 求出 $A(1,:)$：`A(1,:)=deconv(C(1,:),B(1,:));`
- 创建矩阵 $H$：`H=conv2(A(1,:),B);`
- 随后利用 $C(2,:),B(1,:)$ 和 $H$ 通过式 $\eqref{base}$ 求出 $A(2,:)$：`A(2,:)=deconv(C(2,:)-H(2,:),B(1,:));`
- 更新矩阵 $H$：`H=conv2(A(1:2,:),B);`
- 随后利用 $C(3,:),B(1,:)$ 和 $H$ 通过式 $\eqref{base}$ 求出 $A(3,:)$：`A(3,:)=deconv(C(3,:)-H(3,:),B(1,:));`
- 以此类推求得完整的矩阵 $A$ 

完整MATLAB代码如下：

```matlab
function A=deconv2(C,B)

A=zeros(size(C,1)-size(B,1)+1,size(C,2)-size(B,2)+1);
H=zeros(1,size(C,2));
for i=1:size(C,1)-size(B,1)+1
    A(i,:)=deconv(C(i,:)-H(i,:),B(1,:));
    H=conv2(A(1:i,:),B);
end

end
```
对于大小相同的由`rand()`生成的随机方阵 $A$ 和 $B$ ，由`C=conv2(A,B)`与 $B$ 通过反卷积求 $A$ 的运行时间（10次取平均值）与 $A$ 和 $B$ 大小的关系如下图。

<div id="time"></div>

运行时间与矩阵大小大致呈指数关系：

$$\mathrm{Time/ms}=3.583*\exp(0.0343*\mathrm{Size})$$

<script src="https://cdn.plot.ly/plotly-2.29.1.min.js" charset="utf-8"></script>
<script>
    const x = [2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150];
    const y = [0.06042,0.04155,0.04751,0.0512,0.07587,0.0593,0.06886,0.08912,0.11249,0.1414,0.16521,0.21932,0.25513,0.30851,0.30892,0.37653,0.45975,0.51084,0.54939,0.64964,0.73462,0.84873,0.76662,0.8741,0.97833,1.02954,1.13968,1.29981,1.45593,1.60608,1.56726,1.77723,1.94684,2.25735,2.57131,3.02809,3.24736,3.69263,3.59798,3.97046,3.91618,4.35413,4.6297,5.69036,6.40215,6.69479,5.93304,6.96372,7.81414,8.42737,8.8358,9.63952,10.46631,11.2298,11.55059,12.96031,13.74564,14.79279,15.91259,17.01206,18.4552,19.68293,18.08723,19.40486,20.99089,22.66482,24.09951,25.77149,27.24878,29.48357,27.82425,29.24525,31.52243,33.68939,35.55893,39.30073,41.01158,44.46291,44.77759,47.40448,50.54459,54.22582,56.60426,60.42607,62.90954,68.02355,62.00942,67.59722,71.22162,75.47409,79.95499,85.76749,88.34433,93.10149,85.99982,92.09636,96.84601,102.50607,107.17268,113.07813,120.09011,125.42066,127.34583,138.11337,145.26501,150.01799,155.74699,161.86373,171.33492,179.01194,165.10284,177.53828,189.77809,194.83806,203.19437,211.17273,217.87117,228.84536,213.94128,224.98694,237.00129,248.51748,260.86442,274.84926,282.7317,294.74257,299.15073,318.5057,330.01515,341.63889,360.88606,379.40323,396.53892,407.29379,377.97433,396.02772,407.90782,424.11444,441.57887,466.0127,482.52921,504.32015,473.58667,496.49054,513.68988,539.79026,556.71854,574.49838,597.26593];
    var Data = [{
        x: x,
        y: y,
        mode: 'lines',
        type: 'scatter',
        line: {width: 3}
    }];
    var Layout = {
        xaxis: {
            title: {
                text: '矩阵大小',
                font: {size: 18}
            },
            zeroline: false,
            mirror: true,
            linecolor: '#000',
            linewidth: 1.5,
            tickfont: {size: 16}
        },
        yaxis: {
            title: {
                text: '运行时间 (ms)',
                font: {size: 18}
            },
            zeroline: false,
            mirror: true,
            linecolor: '#000',
            linewidth: 1.5,
            tickfont: {size: 16}
        }
    };
    var config = {
        staticPlot: false,
        displaylogo: false,
        responsive: true,
        scrollZoom: false,
        modeBarButtonsToRemove: ['toImage','zoom2d','pan2d','select2d','lasso2d','zoomIn2d','zoomOut2d','autoScale2d']
    };
  Plotly.newPlot("time", Data, Layout, config);
</script>
